# LocalBrain Protocol System

Background service and `localbrain://` URL protocol for system-wide integration.

---

## Overview

The LocalBrain protocol system consists of:

1. **Background Daemon** - FastAPI service that runs independently
2. **Menu Tray App** - macOS menu bar app to manage the daemon
3. **Protocol Handler** - Intercepts `localbrain://` URLs and forwards to daemon

**Key Features:**
- Runs even when Electron app is closed
- System-wide URL protocol (`localbrain://`)
- Menu tray with status indicator
- Auto-start capability
- Background ingestion processing

---

## Architecture

```
┌─────────────────────────────────────────────┐
│           System (macOS)                    │
│  localbrain://ingest?text=...              │
└────────────────┬────────────────────────────┘
                 │
                 ↓
         ┌───────────────┐
         │ Protocol      │
         │ Handler       │  (protocol_handler.py)
         └───────┬───────┘
                 │
                 ↓
         ┌───────────────┐
         │ Background    │
         │ Daemon        │  (daemon.py - FastAPI on :8765)
         │               │
         │ - Ingestion   │
         │ - Processing  │
         └───────┬───────┘
                 │
                 ↓
         ┌───────────────┐
         │ Your Vault    │  (markdown files + citations)
         └───────────────┘

         ┌───────────────┐
         │ Menu Tray     │  (tray.py - controls daemon)
         │ ✅ Running    │
         └───────────────┘
```

---

## Setup

### 1. Install Dependencies

```bash
conda activate localbrain
cd electron/backend
pip install -r requirements.txt
```

**New dependencies:**
- `fastapi` - Web framework for daemon
- `uvicorn` - ASGI server
- `rumps` - macOS tray app framework
- `requests` - HTTP client

### 2. Register Protocol Handler

```bash
# Make setup script executable
chmod +x scripts/setup_protocol.sh

# Run setup
./scripts/setup_protocol.sh
```

This will:
- Register `localbrain://` with macOS
- Create protocol handler wrapper
- Set up LaunchAgent for auto-handling

### 3. Start Background Service

**Option 1: Menu Tray App (Recommended)**
```bash
python src/tray.py
```

The tray app will:
- Show in menu bar
- Auto-start daemon
- Show status (✅ Running / ⚠️ Stopped)
- Let you start/stop service

**Option 2: Direct Daemon**
```bash
python src/daemon.py
```

---

## Usage

### Protocol: `localbrain://ingest`

Ingest content from anywhere in the system.

**Format:**
```
localbrain://ingest?text=CONTENT&platform=PLATFORM&timestamp=ISO8601&url=URL
```

**Parameters:**
- `text` (required) - Content to ingest
- `platform` (optional) - Source platform (e.g., "Gmail", "Discord", "Manual")
- `timestamp` (optional) - ISO 8601 timestamp (auto-generated if omitted)
- `url` (optional) - Source URL

**Examples:**

```bash
# Basic ingestion
open "localbrain://ingest?text=Hello%20World&platform=Test"

# With full metadata
open "localbrain://ingest?text=Got%20offer%20from%20Meta&platform=Gmail&timestamp=2024-10-25T10:30:00Z&url=https://mail.google.com/..."

# From script
curl -X POST http://localhost:8765/protocol/ingest \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Content here",
    "platform": "Discord",
    "timestamp": "2024-10-25T15:00:00Z"
  }'
```

**Note:** The `quote` field in metadata is auto-generated by the LLM during ingestion based on the content. You don't need to provide it.

---

## Components

### 1. Daemon (`src/daemon.py`)

FastAPI service that handles ingestion requests.

**Endpoints:**
- `GET /health` - Health check
- `POST /protocol/ingest` - Handle ingestion
- `GET /protocol/parse?url=...` - Parse protocol URL

**Port:** 8765  
**Logs:** `/tmp/localbrain-daemon.log`

**Start:**
```bash
python src/daemon.py
```

### 2. Menu Tray (`src/tray.py`)

macOS menu bar application.

**Features:**
- Status indicator (✅/⚠️)
- Start/Stop daemon
- Recent ingestions (TODO)
- Auto-start daemon

**Start:**
```bash
python src/tray.py
```

### 3. Protocol Handler (`src/protocol_handler.py`)

Intercepts `localbrain://` URLs from the OS.

**Called automatically by macOS when URLs are opened.**

**Manual test:**
```bash
python src/protocol_handler.py "localbrain://ingest?text=Hello&platform=Test"
```

**Logs:** `/tmp/localbrain-protocol.log`

---

## Testing

### 1. Check Daemon Status

```bash
curl http://localhost:8765/health
```

Expected:
```json
{"status": "healthy", "service": "localbrain-daemon"}
```

### 2. Test Ingestion via API

```bash
curl -X POST http://localhost:8765/protocol/ingest \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Test ingestion from curl",
    "platform": "Manual"
  }'
```

### 3. Test Protocol Handler

```bash
open "localbrain://ingest?text=Test%20from%20protocol&platform=URLTest"
```

Check logs:
```bash
tail -f /tmp/localbrain-protocol.log
tail -f /tmp/localbrain-daemon.log
```

---

## Configuration

### Change Vault Path

Edit `src/daemon.py`:
```python
VAULT_PATH = Path.home() / "your" / "vault" / "path"
```

### Change Port

Edit `src/daemon.py`:
```python
PORT = 8765  # Change to your preferred port
```

Also update in `src/tray.py`:
```python
DAEMON_PORT = 8765  # Match daemon port
```

---

## Auto-Start on Login

To make the tray app start automatically on macOS login:

### Option 1: System Preferences
1. Open **System Preferences** → **Users & Groups** → **Login Items**
2. Click **+** and add the tray app script

### Option 2: LaunchAgent (Advanced)

Create `~/Library/LaunchAgents/com.localbrain.tray.plist`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.localbrain.tray</string>
    <key>ProgramArguments</key>
    <array>
        <string>/path/to/python</string>
        <string>/path/to/localbrain/electron/backend/src/tray.py</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
</dict>
</plist>
```

Load it:
```bash
launchctl load ~/Library/LaunchAgents/com.localbrain.tray.plist
```

---

## Integration Examples

### From Alfred Workflow

```applescript
on alfred_script(q)
    set encodedText to do shell script "python -c 'import urllib.parse; print(urllib.parse.quote(\"" & q & "\"))'"
    do shell script "open 'localbrain://ingest?text=" & encodedText & "&platform=Alfred'"
end alfred_script
```

### From Raycast Script

```bash
#!/bin/bash
# @raycast.title Ingest to LocalBrain
# @raycast.mode silent

text="$1"
encoded=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$text'))")
open "localbrain://ingest?text=$encoded&platform=Raycast"
```

### From Python

```python
import urllib.parse
import subprocess

def ingest_to_localbrain(text: str, platform: str = "Python"):
    encoded_text = urllib.parse.quote(text)
    url = f"localbrain://ingest?text={encoded_text}&platform={platform}"
    subprocess.run(["open", url])

# Usage
ingest_to_localbrain("My important note", "MyApp")
```

---

## Troubleshooting

### "Daemon not running"

Check if daemon is running:
```bash
curl http://localhost:8765/health
```

If not, start it:
```bash
python src/tray.py  # or python src/daemon.py
```

### "Protocol not registered"

Re-run setup:
```bash
./scripts/setup_protocol.sh
```

### "Permission denied"

Make scripts executable:
```bash
chmod +x src/daemon.py
chmod +x src/tray.py
chmod +x src/protocol_handler.py
```

### Check Logs

```bash
# Protocol handler
tail -f /tmp/localbrain-protocol.log

# Daemon
tail -f /tmp/localbrain-daemon.log

# Wrapper script
tail -f /tmp/localbrain-protocol-wrapper.log
```

---

## Future Enhancements

- [ ] Show recent ingestions in tray menu
- [ ] Notification for successful ingestions
- [ ] Support for `localbrain://search` protocol
- [ ] Support for `localbrain://open` protocol
- [ ] Windows/Linux support
- [ ] Electron integration (deep link to app)
- [ ] Queue system for offline ingestions

---

## See Also

- Main README: `../README.md`
- Ingestion Guide: `README.md`
- Citation System: `CITATION_SYSTEM.md`
